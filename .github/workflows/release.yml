name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: ðŸ“¦ Install dependencies
        run: npm ci
      
      - name: ðŸ§ª Run tests
        run: npm test
      
      - name: ðŸ“Š Generate coverage
        run: npm run test:coverage
      
      # GÃ©nÃ©ration des notes de release
      - name: ðŸ“ Generate release notes
        id: release-notes
        run: |
          echo "## ðŸš€ NouveautÃ©s" > release-notes.md
          echo "" >> release-notes.md
          
          # RÃ©cupÃ©rer les commits depuis le dernier tag
          LAST_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [ -n "$LAST_TAG" ]; then
            echo "### ðŸ“‹ Changements depuis $LAST_TAG" >> release-notes.md
            git log --pretty=format:"- %s (%an)" $LAST_TAG..HEAD >> release-notes.md
          else
            echo "### ðŸ“‹ Changements" >> release-notes.md
            git log --pretty=format:"- %s (%an)" --max-count=20 >> release-notes.md
          fi
          
          echo "" >> release-notes.md
          echo "### ðŸ“Š Statistiques" >> release-notes.md
          echo "- âœ… $(npm test 2>&1 | grep -o '[0-9]* passed' | head -1 || echo 'Tests passÃ©s')" >> release-notes.md
          echo "- ðŸ“¦ Version Node.js supportÃ©e: 16, 18, 20" >> release-notes.md
          echo "- ðŸ—„ï¸  Base de donnÃ©es: SQLite" >> release-notes.md
      
      # CrÃ©ation de l'archive
      - name: ðŸ“¦ Create release archive
        run: |
          # CrÃ©er une archive propre du projet
          mkdir -p release-package
          cp -r controllers models routes *.js package*.json release-package/
          tar -czf api-livres-${GITHUB_REF#refs/tags/}.tar.gz release-package/
          zip -r api-livres-${GITHUB_REF#refs/tags/}.zip release-package/
      
      # CrÃ©ation de la release GitHub
      - name: ðŸŽ‰ Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          body_path: release-notes.md
          files: |
            api-livres-*.tar.gz
            api-livres-*.zip
          draft: false
          prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      # Publication sur npm (optionnel)
      - name: ðŸ“¤ Publish to npm
        run: |
          echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}" > ~/.npmrc
          npm publish --access public || echo "NPM publish skipped"
        continue-on-error: true
        if: ${{ secrets.NPM_TOKEN }}
  
  # Notification
  notify:
    name: Notify Release
    runs-on: ubuntu-latest
    needs: create-release
    
    steps:
      - name: ðŸ“¢ Send notification
        run: |
          echo "ðŸŽ‰ Nouvelle release crÃ©Ã©e: ${GITHUB_REF#refs/tags/}"
          echo "ðŸ“¥ TÃ©lÃ©chargeable sur: https://github.com/${{ github.repository }}/releases"
